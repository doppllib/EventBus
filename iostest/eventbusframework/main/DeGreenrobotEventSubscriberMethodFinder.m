//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//

#include "DeGreenrobotEventEventBus.h"
#include "DeGreenrobotEventEventBusException.h"
#include "DeGreenrobotEventSubscriberMethod.h"
#include "DeGreenrobotEventSubscriberMethodFinder.h"
#include "DeGreenrobotEventThreadMode.h"
#include "IOSClass.h"
#include "IOSObjectArray.h"
#include "J2ObjC_source.h"
#include "android/util/Log.h"
#include "java/lang/StringBuilder.h"
#include "java/lang/reflect/Method.h"
#include "java/lang/reflect/Modifier.h"
#include "java/util/ArrayList.h"
#include "java/util/HashMap.h"
#include "java/util/HashSet.h"
#include "java/util/List.h"
#include "java/util/Map.h"
#include "java/util/concurrent/ConcurrentHashMap.h"

@interface DeGreenrobotEventSubscriberMethodFinder () {
 @public
  id<JavaUtilMap> skipMethodVerificationForClasses_;
}

@end

J2OBJC_FIELD_SETTER(DeGreenrobotEventSubscriberMethodFinder, skipMethodVerificationForClasses_, id<JavaUtilMap>)

inline NSString *DeGreenrobotEventSubscriberMethodFinder_get_ON_EVENT_METHOD_NAME();
static NSString *DeGreenrobotEventSubscriberMethodFinder_ON_EVENT_METHOD_NAME = @"onEvent";
J2OBJC_STATIC_FIELD_OBJ_FINAL(DeGreenrobotEventSubscriberMethodFinder, ON_EVENT_METHOD_NAME, NSString *)

inline jint DeGreenrobotEventSubscriberMethodFinder_get_BRIDGE();
#define DeGreenrobotEventSubscriberMethodFinder_BRIDGE 64
J2OBJC_STATIC_FIELD_CONSTANT(DeGreenrobotEventSubscriberMethodFinder, BRIDGE, jint)

inline jint DeGreenrobotEventSubscriberMethodFinder_get_SYNTHETIC();
#define DeGreenrobotEventSubscriberMethodFinder_SYNTHETIC 4096
J2OBJC_STATIC_FIELD_CONSTANT(DeGreenrobotEventSubscriberMethodFinder, SYNTHETIC, jint)

inline jint DeGreenrobotEventSubscriberMethodFinder_get_MODIFIERS_IGNORE();
#define DeGreenrobotEventSubscriberMethodFinder_MODIFIERS_IGNORE 5192
J2OBJC_STATIC_FIELD_CONSTANT(DeGreenrobotEventSubscriberMethodFinder, MODIFIERS_IGNORE, jint)

inline id<JavaUtilMap> DeGreenrobotEventSubscriberMethodFinder_get_methodCache();
static id<JavaUtilMap> DeGreenrobotEventSubscriberMethodFinder_methodCache;
J2OBJC_STATIC_FIELD_OBJ_FINAL(DeGreenrobotEventSubscriberMethodFinder, methodCache, id<JavaUtilMap>)

J2OBJC_INITIALIZED_DEFN(DeGreenrobotEventSubscriberMethodFinder)

@implementation DeGreenrobotEventSubscriberMethodFinder

- (instancetype)initWithJavaUtilList:(id<JavaUtilList>)skipMethodVerificationForClassesList {
  DeGreenrobotEventSubscriberMethodFinder_initWithJavaUtilList_(self, skipMethodVerificationForClassesList);
  return self;
}

- (id<JavaUtilList>)findSubscriberMethodsWithIOSClass:(IOSClass *)subscriberClass {
  NSString *key = [((IOSClass *) nil_chk(subscriberClass)) getName];
  id<JavaUtilList> subscriberMethods;
  @synchronized(DeGreenrobotEventSubscriberMethodFinder_methodCache) {
    subscriberMethods = [((id<JavaUtilMap>) nil_chk(DeGreenrobotEventSubscriberMethodFinder_methodCache)) getWithId:key];
  }
  if (subscriberMethods != nil) {
    return subscriberMethods;
  }
  subscriberMethods = create_JavaUtilArrayList_init();
  IOSClass *clazz = subscriberClass;
  JavaUtilHashSet *eventTypesFound = create_JavaUtilHashSet_init();
  JavaLangStringBuilder *methodKeyBuilder = create_JavaLangStringBuilder_init();
  while (clazz != nil) {
    NSString *name = [clazz getName];
    if ([((NSString *) nil_chk(name)) hasPrefix:@"java."] || [name hasPrefix:@"javax."] || [name hasPrefix:@"android."]) {
      break;
    }
    IOSObjectArray *methods = [clazz getDeclaredMethods];
    {
      IOSObjectArray *a__ = methods;
      JavaLangReflectMethod * const *b__ = ((IOSObjectArray *) nil_chk(a__))->buffer_;
      JavaLangReflectMethod * const *e__ = b__ + a__->size_;
      while (b__ < e__) {
        JavaLangReflectMethod *method = *b__++;
        NSString *methodName = [((JavaLangReflectMethod *) nil_chk(method)) getName];
        if ([((NSString *) nil_chk(methodName)) hasPrefix:DeGreenrobotEventSubscriberMethodFinder_ON_EVENT_METHOD_NAME]) {
          jint modifiers = [method getModifiers];
          if ((modifiers & JavaLangReflectModifier_PUBLIC) != 0 && (modifiers & DeGreenrobotEventSubscriberMethodFinder_MODIFIERS_IGNORE) == 0) {
            IOSObjectArray *parameterTypes = [method getParameterTypes];
            if (((IOSObjectArray *) nil_chk(parameterTypes))->size_ == 1) {
              NSString *modifierString = [methodName java_substring:((jint) [((NSString *) nil_chk(DeGreenrobotEventSubscriberMethodFinder_ON_EVENT_METHOD_NAME)) length])];
              DeGreenrobotEventThreadMode *threadMode;
              if (((jint) [((NSString *) nil_chk(modifierString)) length]) == 0) {
                threadMode = JreLoadEnum(DeGreenrobotEventThreadMode, PostThread);
              }
              else if ([modifierString isEqual:@"MainThread"]) {
                threadMode = JreLoadEnum(DeGreenrobotEventThreadMode, MainThread);
              }
              else if ([modifierString isEqual:@"BackgroundThread"]) {
                threadMode = JreLoadEnum(DeGreenrobotEventThreadMode, BackgroundThread);
              }
              else if ([modifierString isEqual:@"Async"]) {
                threadMode = JreLoadEnum(DeGreenrobotEventThreadMode, Async);
              }
              else {
                if ([((id<JavaUtilMap>) nil_chk(skipMethodVerificationForClasses_)) containsKeyWithId:clazz]) {
                  continue;
                }
                else {
                  @throw create_DeGreenrobotEventEventBusException_initWithNSString_(JreStrcat("$@", @"Illegal onEvent method, check for typos: ", method));
                }
              }
              IOSClass *eventType = IOSObjectArray_Get(parameterTypes, 0);
              [methodKeyBuilder setLengthWithInt:0];
              [methodKeyBuilder appendWithNSString:methodName];
              [((JavaLangStringBuilder *) nil_chk([methodKeyBuilder appendWithChar:'>'])) appendWithNSString:[((IOSClass *) nil_chk(eventType)) getName]];
              NSString *methodKey = [methodKeyBuilder description];
              if ([eventTypesFound addWithId:methodKey]) {
                [subscriberMethods addWithId:create_DeGreenrobotEventSubscriberMethod_initWithJavaLangReflectMethod_withDeGreenrobotEventThreadMode_withIOSClass_(method, threadMode, eventType)];
              }
            }
          }
          else if (![((id<JavaUtilMap>) nil_chk(skipMethodVerificationForClasses_)) containsKeyWithId:clazz]) {
            AndroidUtilLog_dWithNSString_withNSString_(JreLoadStatic(DeGreenrobotEventEventBus, TAG), JreStrcat("$@C$", @"Skipping method (not public, static or abstract): ", clazz, '.', methodName));
          }
        }
      }
    }
    clazz = [clazz getSuperclass];
  }
  if ([subscriberMethods isEmpty]) {
    @throw create_DeGreenrobotEventEventBusException_initWithNSString_(JreStrcat("$@$$", @"Subscriber ", subscriberClass, @" has no public methods called ", DeGreenrobotEventSubscriberMethodFinder_ON_EVENT_METHOD_NAME));
  }
  else {
    @synchronized(DeGreenrobotEventSubscriberMethodFinder_methodCache) {
      [DeGreenrobotEventSubscriberMethodFinder_methodCache putWithId:key withId:subscriberMethods];
    }
    return subscriberMethods;
  }
}

+ (void)clearCaches {
  DeGreenrobotEventSubscriberMethodFinder_clearCaches();
}

- (void)dealloc {
  RELEASE_(skipMethodVerificationForClasses_);
  [super dealloc];
}

+ (const J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { NULL, NULL, 0x0, -1, 0, -1, 1, -1, -1 },
    { NULL, "LJavaUtilList;", 0x0, 2, 3, -1, 4, -1, -1 },
    { NULL, "V", 0x8, -1, -1, -1, -1, -1, -1 },
  };
  #pragma clang diagnostic push
  #pragma clang diagnostic ignored "-Wobjc-multiple-method-names"
  methods[0].selector = @selector(initWithJavaUtilList:);
  methods[1].selector = @selector(findSubscriberMethodsWithIOSClass:);
  methods[2].selector = @selector(clearCaches);
  #pragma clang diagnostic pop
  static const J2ObjcFieldInfo fields[] = {
    { "ON_EVENT_METHOD_NAME", "LNSString;", .constantValue.asLong = 0, 0x1a, -1, 5, -1, -1 },
    { "BRIDGE", "I", .constantValue.asInt = DeGreenrobotEventSubscriberMethodFinder_BRIDGE, 0x1a, -1, -1, -1, -1 },
    { "SYNTHETIC", "I", .constantValue.asInt = DeGreenrobotEventSubscriberMethodFinder_SYNTHETIC, 0x1a, -1, -1, -1, -1 },
    { "MODIFIERS_IGNORE", "I", .constantValue.asInt = DeGreenrobotEventSubscriberMethodFinder_MODIFIERS_IGNORE, 0x1a, -1, -1, -1, -1 },
    { "methodCache", "LJavaUtilMap;", .constantValue.asLong = 0, 0x1a, -1, 6, 7, -1 },
    { "skipMethodVerificationForClasses_", "LJavaUtilMap;", .constantValue.asLong = 0, 0x12, -1, -1, 8, -1 },
  };
  static const void *ptrTable[] = { "LJavaUtilList;", "(Ljava/util/List<Ljava/lang/Class<*>;>;)V", "findSubscriberMethods", "LIOSClass;", "(Ljava/lang/Class<*>;)Ljava/util/List<Lde/greenrobot/event/SubscriberMethod;>;", &DeGreenrobotEventSubscriberMethodFinder_ON_EVENT_METHOD_NAME, &DeGreenrobotEventSubscriberMethodFinder_methodCache, "Ljava/util/Map<Ljava/lang/String;Ljava/util/List<Lde/greenrobot/event/SubscriberMethod;>;>;", "Ljava/util/Map<Ljava/lang/Class<*>;Ljava/lang/Class<*>;>;" };
  static const J2ObjcClassInfo _DeGreenrobotEventSubscriberMethodFinder = { "SubscriberMethodFinder", "de.greenrobot.event", ptrTable, methods, fields, 7, 0x0, 3, 6, -1, -1, -1, -1, -1 };
  return &_DeGreenrobotEventSubscriberMethodFinder;
}

+ (void)initialize {
  if (self == [DeGreenrobotEventSubscriberMethodFinder class]) {
    JreStrongAssignAndConsume(&DeGreenrobotEventSubscriberMethodFinder_methodCache, new_JavaUtilHashMap_init());
    J2OBJC_SET_INITIALIZED(DeGreenrobotEventSubscriberMethodFinder)
  }
}

@end

void DeGreenrobotEventSubscriberMethodFinder_initWithJavaUtilList_(DeGreenrobotEventSubscriberMethodFinder *self, id<JavaUtilList> skipMethodVerificationForClassesList) {
  NSObject_init(self);
  JreStrongAssignAndConsume(&self->skipMethodVerificationForClasses_, new_JavaUtilConcurrentConcurrentHashMap_init());
  if (skipMethodVerificationForClassesList != nil) {
    for (IOSClass * __strong clazz in skipMethodVerificationForClassesList) {
      [self->skipMethodVerificationForClasses_ putWithId:clazz withId:clazz];
    }
  }
}

DeGreenrobotEventSubscriberMethodFinder *new_DeGreenrobotEventSubscriberMethodFinder_initWithJavaUtilList_(id<JavaUtilList> skipMethodVerificationForClassesList) {
  J2OBJC_NEW_IMPL(DeGreenrobotEventSubscriberMethodFinder, initWithJavaUtilList_, skipMethodVerificationForClassesList)
}

DeGreenrobotEventSubscriberMethodFinder *create_DeGreenrobotEventSubscriberMethodFinder_initWithJavaUtilList_(id<JavaUtilList> skipMethodVerificationForClassesList) {
  J2OBJC_CREATE_IMPL(DeGreenrobotEventSubscriberMethodFinder, initWithJavaUtilList_, skipMethodVerificationForClassesList)
}

void DeGreenrobotEventSubscriberMethodFinder_clearCaches() {
  DeGreenrobotEventSubscriberMethodFinder_initialize();
  @synchronized(DeGreenrobotEventSubscriberMethodFinder_methodCache) {
    [((id<JavaUtilMap>) nil_chk(DeGreenrobotEventSubscriberMethodFinder_methodCache)) clear];
  }
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(DeGreenrobotEventSubscriberMethodFinder)
